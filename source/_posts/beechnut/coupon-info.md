---
title: 探究：优惠券的设计
categories: [架构]
tags: [优惠券,设计]
date: 2019-11-05 14:15:10
description: 优惠券一直都是系统中较为复杂的部分，往往设计多个模块（支付、活动、用户等等），将从架构设计角度展开，设计一种合理的架构
---

最近几天，和朋友讨论了许多优惠券相关的问题，他以产品的角度，探究优惠券的意义场景等。他阐释，优惠券的本质是价格歧视，通过对不同消费者提供不同的收费标准，以此来增加营收。

当然，从我的角度出发（程序猿），我并不关心优惠券的目的，而更感兴趣于架构的设计，毕竟这块很有挑战性。比如满减或者折扣等涉及支付系统，用户领取使用又涉及用户系统等等（这里假设在微服务架构下）通常优惠券会影响多个系统，除此外，优惠规则与限制条件又十分复杂。但越难才越有意思。

我初步将优惠券系统分为以下四个部分：

- 优惠券主体，简单说定义名称或者一些说明之类
- 优惠策略，定义处理优惠的方式
- 限制规则，在这部分中定义什么条件下可使用或者“过期”
- 发放策略，定义何时如何发放，一般情况下与用户和活动系统相关

<!-- more -->

![](https://jiangtj-lab.github.io/pic-repo/img-apricot/20191106145354.png)

*发放策略与其他系统紧密相关，暂时未设计数据结构*

# 优惠券主体

前期这部分比较简单，对应优惠券的主要信息，用于查询与展示。但后期如果需要对优惠券美化时，就需要扩展这部分来支持

建议创建后不允许修改优惠券，为后续订单追溯优惠提供可能

# 优惠策略

优惠的策略与主体间是1对1的关系（一张优惠券一种优惠方式），理论上这部分可以和主体存放在一张表内

优惠策略的关键在于handler处理器，所有的优惠策略处理器都需要继承优惠处理器相关的接口，例如java版如下（其他语言应该也能有类似的功能把）

```java
public interface DiscountHandler {

    /**
     * DiscountHandler Name
     */
    String name();

    /**
     * handle price
     */
    default BigDecimal handle(BigDecimal price, String args) {
        return price;
    }

    /**
     * handle order, default 0
     */
    default int order() {
        return 0;
    }

}
```

当用户选择优惠券(多张)后，获取选择的优惠券的处理器并依据order排序，依次处理价格

# 限制规则

> TBD
